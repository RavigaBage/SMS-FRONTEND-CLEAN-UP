<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Parent Portal â€” Complete Registration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      font-family: 'DM Sans', Helvetica, Arial, sans-serif;
      color: #0f172a;
    }

    #app { width: 100%; max-width: 520px; }

    /* â”€â”€ accent bars â”€â”€ */
    .accent-top    { height: 4px; background: linear-gradient(90deg,#1a56db 0%,#4f9cf9 60%,#1a56db 100%); }
    .accent-bottom { height: 3px; background: linear-gradient(90deg,#1a56db 0%,#4f9cf9 60%,#1a56db 100%); }

    /* â”€â”€ card â”€â”€ */
    .card { background: #fff; padding: 44px 48px 48px; }

    /* â”€â”€ animations â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .fade-up   { animation: fadeUp 0.4s ease forwards; }
    .fade-up-2 { animation: fadeUp 0.4s 0.1s ease both; }
    .fade-up-3 { animation: fadeUp 0.4s 0.2s ease both; }

    /* â”€â”€ header â”€â”€ */
    .header { text-align: center; margin-bottom: 36px; }
    .emblem {
      width: 56px; height: 56px;
      background: #1a56db;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 24px; margin-bottom: 20px;
    }
    .portal-label {
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.2em; text-transform: uppercase;
      color: #1a56db; margin-bottom: 8px;
    }
    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: 30px; font-weight: 700;
      color: #0f172a; line-height: 1.2; margin-bottom: 10px;
    }
    .welcome-sub { font-size: 14px; color: #64748b; line-height: 1.6; }
    .welcome-sub strong { color: #0f172a; }

    /* â”€â”€ wards strip â”€â”€ */
    .wards-box { border: 1px solid #e2e8f0; margin-bottom: 32px; }
    .wards-header {
      padding: 10px 16px; background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.15em; text-transform: uppercase; color: #94a3b8;
    }
    .ward-row {
      padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid #f1f5f9;
    }
    .ward-name  { font-size: 14px; font-weight: 500; color: #0f172a; }
    .ward-adm   { font-size: 12px; color: #94a3b8; margin-top: 2px; }
    .ward-badge {
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: #1a56db; background: #eff6ff;
      border: 1px solid #bfdbfe; padding: 3px 10px;
    }
    .expiry-bar {
      padding: 10px 16px; background: #fffbeb;
      border-top: 1px solid #fef3c7;
      font-size: 12px; color: #92400e;
    }
    .expiry-bar strong { color: #78350f; }

    /* â”€â”€ form fields â”€â”€ */
    .field { margin-bottom: 20px; }
    .field label {
      display: block; font-size: 11px; font-weight: 600;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: #64748b; margin-bottom: 8px;
    }
    .field-wrap { position: relative; }
    .field input {
      width: 100%; padding: 13px 16px;
      font-size: 15px; font-family: 'DM Sans', sans-serif; font-weight: 400;
      color: #0f172a; background: #fff;
      border: 1px solid #e2e8f0; outline: none;
      transition: border-color 0.2s;
    }
    .field input.has-toggle { padding-right: 56px; }
    .field input:focus       { border-color: #1a56db; }
    .field input.is-error    { border-color: #ef4444; }
    .field input.is-error:focus { border-color: #ef4444; }
    .field-error { margin-top: 6px; font-size: 12px; color: #ef4444; display: none; }
    .field-error.visible { display: block; }

    /* show/hide toggle */
    .toggle-btn {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer;
      color: #94a3b8; font-size: 13px;
      font-family: 'DM Sans', sans-serif; padding: 0;
    }

    /* â”€â”€ password strength â”€â”€ */
    #strength-wrap { margin-top: 8px; display: none; }
    #strength-wrap.visible { display: block; }
    .strength-bars { display: flex; gap: 4px; margin-bottom: 6px; }
    .strength-bar  { flex: 1; height: 3px; background: #e2e8f0; transition: background 0.3s; }
    .strength-checks { display: flex; gap: 12px; flex-wrap: wrap; }
    .strength-check {
      font-size: 11px; color: #94a3b8;
      display: flex; align-items: center; gap: 4px;
      transition: color 0.2s;
    }
    .strength-check.ok { color: #22c55e; }

    /* â”€â”€ submit button â”€â”€ */
    #submit-btn {
      width: 100%; padding: 15px;
      background: #1a56db; color: #fff;
      border: none; cursor: pointer;
      font-size: 15px; font-weight: 500;
      font-family: 'DM Sans', sans-serif;
      letter-spacing: 0.03em; margin-top: 8px;
      transition: background 0.2s, opacity 0.2s;
    }
    #submit-btn:disabled { background: #93c5fd; cursor: not-allowed; }

    /* â”€â”€ footer note â”€â”€ */
    .footer-note {
      margin-top: 24px; text-align: center;
      font-size: 12px; color: #cbd5e1; line-height: 1.6;
    }
    .footer-note strong { color: #94a3b8; }

    /* â”€â”€ state screens â”€â”€ */
    .state-screen { background: #fff; padding: 52px 48px; text-align: center; }
    .state-icon   { font-size: 40px; margin-bottom: 20px; }
    .state-title  {
      font-family: 'Playfair Display', serif;
      font-size: 26px; color: #0f172a; margin-bottom: 12px;
    }
    .state-body   { font-size: 15px; color: #64748b; line-height: 1.7; }

    .error-strip {
      margin-top: 32px; padding: 14px 20px;
      background: #fef2f2; border-left: 3px solid #ef4444;
      text-align: left; font-size: 13px; color: #b91c1c;
    }
    .amber-strip {
      margin-top: 32px; padding: 14px 20px;
      background: #fffbeb; border-left: 3px solid #f59e0b;
      font-size: 13px; color: #92400e;
    }
    .amber-strip strong { color: #78350f; }

    .success-icon {
      width: 64px; height: 64px;
      background: #f0fdf4; border: 2px solid #bbf7d0;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 28px; margin-bottom: 24px;
    }

    .btn-primary {
      display: inline-block; padding: 14px 40px;
      background: #1a56db; color: #fff;
      text-decoration: none; font-size: 15px; font-weight: 500;
      font-family: 'DM Sans', sans-serif; letter-spacing: 0.02em;
      border: none; cursor: pointer; margin-top: 28px;
    }

    /* â”€â”€ spinner â”€â”€ */
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid #e2e8f0; border-top-color: #1a56db;
      border-radius: 50%; margin: 0 auto 20px;
      animation: spin 0.8s linear infinite;
    }

    /* â”€â”€ hidden â”€â”€ */
    .hidden { display: none !important; }

    /* â”€â”€ responsive â”€â”€ */
    @media (max-width: 560px) {
      .card, .state-screen { padding: 32px 24px; }
    }
  </style>
</head>
<body>

<div id="app">

  <!-- â”€â”€ CHECKING â”€â”€ -->
  <div id="screen-checking">
    <div style="text-align:center;padding:60px 0;">
      <div class="spinner"></div>
      <p style="color:#64748b;font-size:15px;">Verifying your invitationâ€¦</p>
    </div>
  </div>

  <!-- â”€â”€ INVALID â”€â”€ -->
  <div id="screen-invalid" class="hidden fade-up">
    <div class="accent-top"></div>
    <div class="state-screen">
      <div class="state-icon">âš ï¸</div>
      <h2 class="state-title">Invalid Invitation</h2>
      <p class="state-body">
        This invite link is invalid, has already been used, or has expired.
        Please contact your school administrator for a new invitation.
      </p>
      <div class="error-strip">
        Code: <strong id="invalid-code-display">â€”</strong>
      </div>
    </div>
    <div class="accent-bottom"></div>
  </div>

  <!-- â”€â”€ SUCCESS â”€â”€ -->
  <div id="screen-success" class="hidden fade-up">
    <div class="accent-top"></div>
    <div class="state-screen">
      <div class="success-icon">âœ“</div>
      <h2 class="state-title" style="font-size:28px;">Account Created!</h2>
      <p class="state-body">
        Welcome, <strong id="success-name" style="color:#0f172a;"></strong>.
        Your parent portal account is ready. You can now log in to the app.
      </p>
      <a href="/login" class="btn-primary">Go to Login â†’</a>
    </div>
    <div class="accent-bottom"></div>
  </div>

  <!-- â”€â”€ ERROR â”€â”€ -->
  <div id="screen-error" class="hidden fade-up">
    <div class="accent-top"></div>
    <div class="state-screen">
      <div class="state-icon">âŒ</div>
      <h2 class="state-title">Registration Failed</h2>
      <p class="state-body" id="error-message">Something went wrong.</p>
      <button class="btn-primary" onclick="showScreen('form')">â† Try Again</button>
    </div>
    <div class="accent-bottom"></div>
  </div>

  <!-- â”€â”€ FORM â”€â”€ -->
  <div id="screen-form" class="hidden">
    <div class="accent-top"></div>
    <div class="card">

      <!-- Header -->
      <div class="header fade-up">
        <div class="emblem">ğŸ“</div>
        <p class="portal-label">Parent Portal</p>
        <h1 class="page-title">Complete Registration</h1>
        <p class="welcome-sub">
          Welcome, <strong id="form-parent-name"></strong>.
          Set up your account below.
        </p>
      </div>

      <!-- Wards strip -->
      <div id="wards-box" class="wards-box fade-up-2 hidden">
        <div class="wards-header">Your Registered Student(s)</div>
        <div id="wards-list"></div>
        <div class="expiry-bar">
          â³ Invite expires <strong id="expiry-date"></strong>
        </div>
      </div>

      <!-- Registration form -->
      <form id="reg-form" class="fade-up-3" novalidate>

        <!-- Username -->
        <div class="field">
          <label for="f-username">Username</label>
          <div class="field-wrap">
            <input id="f-username" type="text" placeholder="e.g. linda.williams" autocomplete="username" />
          </div>
          <p class="field-error" id="err-username"></p>
        </div>

        <!-- Email -->
        <div class="field">
          <label for="f-email">Email Address</label>
          <div class="field-wrap">
            <input id="f-email" type="email" placeholder="your@email.com" autocomplete="email" />
          </div>
          <p class="field-error" id="err-email"></p>
        </div>

        <!-- Password -->
        <div class="field">
          <label for="f-password">Password</label>
          <div class="field-wrap">
            <input id="f-password" type="password" class="has-toggle" placeholder="Create a strong password" autocomplete="new-password" />
            <button type="button" class="toggle-btn" data-target="f-password">Show</button>
          </div>
          <p class="field-error" id="err-password"></p>
          <!-- strength indicator -->
          <div id="strength-wrap">
            <div class="strength-bars">
              <div class="strength-bar" id="sb0"></div>
              <div class="strength-bar" id="sb1"></div>
              <div class="strength-bar" id="sb2"></div>
              <div class="strength-bar" id="sb3"></div>
            </div>
            <div class="strength-checks">
              <span class="strength-check" id="sc-len"><span class="sc-icon">â—‹</span> 8+ characters</span>
              <span class="strength-check" id="sc-upper"><span class="sc-icon">â—‹</span> Uppercase</span>
              <span class="strength-check" id="sc-num"><span class="sc-icon">â—‹</span> Number</span>
              <span class="strength-check" id="sc-sym"><span class="sc-icon">â—‹</span> Symbol</span>
            </div>
          </div>
        </div>

        <!-- Confirm password -->
        <div class="field" id="field-confirm" style="margin-top:0;">
          <label for="f-confirm">Confirm Password</label>
          <div class="field-wrap">
            <input id="f-confirm" type="password" class="has-toggle" placeholder="Repeat your password" autocomplete="new-password" />
            <button type="button" class="toggle-btn" data-target="f-confirm">Show</button>
          </div>
          <p class="field-error" id="err-confirm"></p>
        </div>

        <button type="submit" id="submit-btn">Create Account â†’</button>
      </form>

      <p class="footer-note">
        This invitation is personal and non-transferable.<br/>
        Code: <strong id="footer-code"></strong>
      </p>
    </div>
    <div class="accent-bottom"></div>
  </div>

</div><!-- /#app -->

<script>
  const API = 'http://localhost:8000';

  // â”€â”€ read code from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const params = new URLSearchParams(window.location.search);
  const CODE   = params.get('code') || '';

  // â”€â”€ screen manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SCREENS = ['checking', 'invalid', 'form', 'success', 'error'];
  function showScreen(name) {
    SCREENS.forEach(s => {
      const el = document.getElementById('screen-' + s);
      if (el) el.classList.toggle('hidden', s !== name);
    });
  }

  // â”€â”€ format date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function formatDate(iso) {
    if (!iso) return 'N/A';
    return new Date(iso).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  // â”€â”€ Step 1: verify invite code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function checkInvite() {
    if (!CODE) { showInvalid(); return; }

    try {
      const res  = await fetch(`${API}/auth/invite/check/?code=${CODE}`);
      const data = await res.json();
      if (data.valid) {
        populateForm(data);
        showScreen('form');
      } else {
        showInvalid();
      }
    } catch {
      showInvalid();
    }
  })();

  function showInvalid() {
    document.getElementById('invalid-code-display').textContent = CODE || 'none provided';
    showScreen('invalid');
  }

  // â”€â”€ Step 2: populate form with invite data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function populateForm(data) {
    document.getElementById('form-parent-name').textContent = data.parent_name || '';
    document.getElementById('footer-code').textContent      = data.code || CODE;
    document.getElementById('expiry-date').textContent      = formatDate(data.expires_at);

    const list = document.getElementById('wards-list');
    if (data.wards && data.wards.length > 0) {
      list.innerHTML = data.wards.map(w => `
        <div class="ward-row">
          <div>
            <p class="ward-name">${esc(w.first_name)} ${esc(w.last_name)}</p>
            <p class="ward-adm">${esc(w.admission_number)}</p>
          </div>
          <span class="ward-badge">Active</span>
        </div>`).join('');
      document.getElementById('wards-box').classList.remove('hidden');
    }
  }

  // â”€â”€ password strength â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const COLORS = ['#ef4444','#f97316','#eab308','#22c55e'];

  document.getElementById('f-password').addEventListener('input', function () {
    const pw    = this.value;
    const wrap  = document.getElementById('strength-wrap');
    if (!pw.length) { wrap.classList.remove('visible'); return; }
    wrap.classList.add('visible');

    const checks = [
      { id: 'sc-len',   ok: pw.length >= 8 },
      { id: 'sc-upper', ok: /[A-Z]/.test(pw) },
      { id: 'sc-num',   ok: /[0-9]/.test(pw) },
      { id: 'sc-sym',   ok: /[^A-Za-z0-9]/.test(pw) },
    ];
    const score = checks.filter(c => c.ok).length;
    const color = COLORS[score - 1] || '#e2e8f0';

    checks.forEach((c, i) => {
      const el   = document.getElementById(c.id);
      const icon = el.querySelector('.sc-icon');
      el.classList.toggle('ok', c.ok);
      icon.textContent = c.ok ? 'âœ“' : 'â—‹';
      document.getElementById('sb' + i).style.background = i < score ? color : '#e2e8f0';
    });
  });

  // â”€â”€ show/hide password toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const input = document.getElementById(this.dataset.target);
      const shown = input.type === 'text';
      input.type  = shown ? 'password' : 'text';
      this.textContent = shown ? 'Show' : 'Hide';
    });
  });

  // â”€â”€ field validation helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setError(fieldId, errId, msg) {
    const input = document.getElementById(fieldId);
    const err   = document.getElementById(errId);
    input.classList.toggle('is-error', !!msg);
    err.textContent = msg || '';
    err.classList.toggle('visible', !!msg);
  }

  function validate() {
    const username = document.getElementById('f-username').value.trim();
    const email    = document.getElementById('f-email').value.trim();
    const password = document.getElementById('f-password').value;
    const confirm  = document.getElementById('f-confirm').value;
    let   valid    = true;

    if (!username)          { setError('f-username','err-username','Username is required');            valid = false; }
    else if (username.length < 3) { setError('f-username','err-username','Must be at least 3 characters'); valid = false; }
    else                    setError('f-username','err-username','');

    if (!email)             { setError('f-email','err-email','Email is required');              valid = false; }
    else if (!/\S+@\S+\.\S+/.test(email)) { setError('f-email','err-email','Enter a valid email'); valid = false; }
    else                    setError('f-email','err-email','');

    if (!password)          { setError('f-password','err-password','Password is required');            valid = false; }
    else if (password.length < 8) { setError('f-password','err-password','Must be at least 8 characters'); valid = false; }
    else                    setError('f-password','err-password','');

    if (password !== confirm) { setError('f-confirm','err-confirm','Passwords do not match'); valid = false; }
    else                      setError('f-confirm','err-confirm','');

    return valid;
  }

  // â”€â”€ Step 3: form submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('reg-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!validate()) return;

    const btn = document.getElementById('submit-btn');
    btn.disabled     = true;
    btn.textContent  = 'Creating Accountâ€¦';

    try {
      const res  = await fetch(`${API}/auth/invite/redeem/`, {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({
          code:     CODE,
          username: document.getElementById('f-username').value.trim(),
          email:    document.getElementById('f-email').value.trim(),
          password: document.getElementById('f-password').value,
        }),
      });
      const data = await res.json();

      if (res.ok) {
        document.getElementById('success-name').textContent =
          document.getElementById('form-parent-name').textContent;
        showScreen('success');
      } else {
        document.getElementById('error-message').textContent =
          data.error || 'Something went wrong. Please try again.';
        showScreen('error');
      }
    } catch {
      document.getElementById('error-message').textContent =
        'Could not connect to the server. Please check your connection.';
      showScreen('error');
    } finally {
      btn.disabled    = false;
      btn.textContent = 'Create Account â†’';
    }
  });

  // â”€â”€ clear errors on input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [['f-username','err-username'],['f-email','err-email'],
   ['f-password','err-password'],['f-confirm','err-confirm']].forEach(([fid, eid]) => {
    document.getElementById(fid).addEventListener('input', () => setError(fid, eid, ''));
  });

  // â”€â”€ XSS-safe escape â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(str) {
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
</body>
</html>